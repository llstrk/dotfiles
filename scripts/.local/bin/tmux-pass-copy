#!/usr/bin/env bash

set -euo pipefail

store="${PASSWORD_STORE_DIR:-$HOME/.password-store}"

if [ ! -d "$store" ]; then
  echo "password store not found: $store" >&2
  exit 1
fi

entry="$(
  find "$store" -type f -name '*.gpg' -print0 |
    while IFS= read -r -d '' file; do
      rel="${file#"$store"/}"
      printf '%s\n' "${rel%.gpg}"
    done |
    sort |
    fzf --prompt='pass> ' --height=100% --layout=reverse
)"
[ -z "${entry:-}" ] && exit 0

first_line="$(pass show "$entry")"
first_line="${first_line%%$'\n'*}"

action="${TMUX_PASS_ACTION:-copy}"
target_pane="${TARGET_PANE:-}"

if [ -n "${TMUX:-}" ]; then
  tmux set-buffer -w -- "$first_line"
else
  cot "$first_line"
fi

if [ "$action" = "send" ] && [ -n "${TMUX:-}" ] && [ -n "$target_pane" ]; then
  tmux send-keys -t "$target_pane" -l -- "$first_line"
  tmux send-keys -t "$target_pane" Enter
fi
